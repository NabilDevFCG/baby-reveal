<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gender Reveal Puzzle</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f0f0f0; }
    #puzzle, #reveal, #balloon-container { margin-top: 40px; }
    #puzzle-canvas { background: #fff; border: 2px solid #ccc; border-radius: 12px; }
    #reveal-balloon { width: 160px; margin-top: 30px; }
    .hint { color: #888; font-size: 14px; }
    #feedback { font-size: 18px; color: #e67e22; margin-top: 10px; }
    .question { font-size: 22px; margin: 20px 0 10px 0; }
    .choice-btn { margin: 6px; padding: 8px 18px; font-size: 18px; border-radius: 8px; border: 1px solid #bbb; background: #f9f9f9; cursor: pointer; }
    .choice-btn:hover { background: #e0e0e0; }
    #start-btn { margin-top: 60px; font-size: 28px; padding: 18px 40px; border-radius: 12px; background: #f39c12; color: #fff; border: none; cursor: pointer; }
    #start-btn:hover { background: #e67e22; }
  </style>
</head>
<body>
  <h1>Gender Reveal</h1>
  <h1>
    <span style="color:#e75480;">Ahlam</span> &amp; <span style="color:#3498db;">Adil</span>
  </h1>
  <button id="start-btn" style="background:#eda5e3; color:#3498db; font-weight:bold;"><b>Start the Game</b></button>

  <div id="puzzle" style="display:none;">
    <div id="test-area"></div>
    <canvas id="puzzle-canvas" width="700" height="500" style="display:none;"></canvas>
    <p id="feedback"></p>
  </div>
  <div id="reveal" style="display:none;">
    <p>Congratulations! Now go pop the real balloon next to you!</p>
    <div id="balloon-container">
      <img id="reveal-alloon" src="ballon.png" alt="Balloon to reveal" style="width:90%; max-width:700px; height:auto; transition:transform 0.3s; cursor:zoom-in;" onclick="this.style.transform='scale(6)'; this.style.cursor='zoom-out'; this.onclick=function(){this.style.transform='scale(1)'; this.style.cursor='zoom-in'; this.onclick=arguments.callee;}">
    </div>
  </div>

  <!-- Audio files for intro and steps -->
  <audio id="audio-intro" src="intro.mp3"></audio>
  <audio id="audio-q1" src="Q1.mp3"></audio>
  <audio id="audio-q2" src="Q2.mp3"></audio>
  <audio id="audio-q3" src="Q3.mp3"></audio>
  <audio id="audio-q4" src="Q4.mp3"></audio>
  <audio id="audio-steps" src="steps.mp3"></audio>
  <!-- finale.mp3 will be played dynamically -->

  <script>
    const steps = [
      { type: "audio", id: "audio-intro" },
      { type: "qcm", idx: 0, audio: "audio-q1" },
      { type: "suite", idx: 1, audio: "audio-q2" },
      { type: "qcm", idx: 2, audio: "audio-q3" },
      { type: "audio", id: "audio-steps" },
      { type: "intrus", idx: 3, audio: "audio-q4" }
    ];

    const puzzles = [
      {
        type: "qcm",
        question: "Which object is NOT used for a baby?",
        choices: ["Bottle", "Pacifier", "Diapers", "Screwdriver"],
        answer: "Screwdriver"
      },
      {
        type: "suite",
        sequence: ["🍼", "🧸", "🍼", "🧸", "?"],
        choices: ["🍼", "🧸", "🛁"],
        answer: "🍼",
        hint: "Complete the logical sequence of baby items."
      },
      {
        type: "qcm",
        question: "How many months does a typical pregnancy last?",
        choices: ["7", "8", "9", "10"],
        answer: "9"
      },
      {
        type: "intrus",
        animals: [
          { emoji: "👶", x: 100, y: 110 },
          { emoji: "🍼", x: 220, y: 110 },
          { emoji: "🧸", x: 340, y: 110 },
          { emoji: "🚗", x: 460, y: 110 },
          { emoji: "🧷", x: 580, y: 110 }
        ],
        intrusIdx: 3,
        hint: "Click on the odd one out that is not related to a baby."
      }
    ];

    let currentStep = 0;
    let finalePlayed = false; // Prevent double play

    function playAudioStep(audioId, callback) {
      const audio = document.getElementById(audioId);
      if (!audio) { callback(); return; }
      audio.currentTime = 0;
      audio.play();
      audio.onended = () => {
        audio.onended = null;
        callback();
      };
    }

    function showStep() {
      const area = document.getElementById('test-area');
      const canvas = document.getElementById('puzzle-canvas');
      area.innerHTML = '';
      canvas.style.display = 'none';
      document.getElementById('feedback').textContent = "";

      if (currentStep >= steps.length) {
        document.getElementById('puzzle').style.display = 'none';
        document.getElementById('reveal').style.display = 'block';
        if (!finalePlayed) {
          finalePlayed = true;
          setTimeout(() => {
            const audioFinale = new Audio('finale.mp3');
            audioFinale.play();
          }, 500);
        }
        return;
      }

      const step = steps[currentStep];

      if (step.type === "audio") {
        // Show intro.png only for intro audio
        if (step.id === "audio-intro") {
          area.innerHTML = `
            <div class="question" style="color:#3498db;">Listen carefully...</div>
            <img src="intro.png" alt="Intro" style="max-width:80%;margin-top:20px;border-radius:16px;box-shadow:0 4px 16px #bbb;">
          `;
        } else {
          area.innerHTML = `<div class="question" style="color:#3498db;">Listen carefully...</div>`;
        }
        playAudioStep(step.id, () => {
          currentStep++;
          setTimeout(showStep, 400);
        });
      } else if (step.type === "qcm" || step.type === "suite" || step.type === "intrus") {
        showPuzzle(step.idx, step.type, step.audio);
      }
    }

    function showPuzzle(puzzleIdx, puzzleType, audioId) {
      const area = document.getElementById('test-area');
      const canvas = document.getElementById('puzzle-canvas');
      area.innerHTML = '';
      canvas.style.display = 'none';
      document.getElementById('feedback').textContent = "";

      const p = puzzles[puzzleIdx];

      // Show question first, then play audio
      if (puzzleType === "qcm") {
        const q = document.createElement('div');
        q.className = "question";
        q.textContent = p.question;
        area.appendChild(q);
        p.choices.forEach(choice => {
          const btn = document.createElement('button');
          btn.className = "choice-btn";
          btn.textContent = choice;
          btn.onclick = () => {
            if (choice === p.answer) {
              document.getElementById('feedback').textContent = "Correct!";
              setTimeout(() => { currentStep++; showStep(); }, 900);
            } else {
              document.getElementById('feedback').textContent = "Wrong answer, try again!";
              setTimeout(() => document.getElementById('feedback').textContent = "", 1200);
            }
          };
          area.appendChild(btn);
        });
        // Play audio after displaying question
        setTimeout(() => playAudioStep(audioId, () => {}), 200);
      } else if (puzzleType === "suite") {
        area.innerHTML = `<div class="question">Complete the logical sequence:</div>
          <div class="hint">${p.hint}</div>`;
        canvas.style.display = '';
        drawSuitePuzzle(p, () => { currentStep++; showStep(); });
        setTimeout(() => playAudioStep(audioId, () => {}), 200);
      } else if (puzzleType === "intrus") {
        area.innerHTML = `<div class="question">Which is the odd one out?</div>
          <div class="hint">${p.hint}</div>`;
        canvas.style.display = '';
        drawIntrusPuzzle(p, () => { currentStep++; showStep(); });
        setTimeout(() => playAudioStep(audioId, () => {}), 200);
      }
    }

    function drawSuitePuzzle(p, onSuccess) {
      const canvas = document.getElementById('puzzle-canvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      let startX = 120;
      for (let i = 0; i < p.sequence.length; i++) {
        ctx.beginPath();
        ctx.lineWidth = 2;
        ctx.strokeStyle = "#bbb";
        ctx.rect(startX + i * 90, 60, 60, 60);
        ctx.stroke();
        ctx.font = "48px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        if (p.sequence[i] !== "?") {
          ctx.fillText(p.sequence[i], startX + i * 90 + 30, 90);
        } else {
          ctx.fillStyle = "#e67e22";
          ctx.fillText("?", startX + i * 90 + 30, 90);
        }
      }
      let choices = p.choices.map((emoji, idx) => ({
        emoji,
        x: 200 + idx * 120,
        y: 170
      }));
      drawChoices(ctx, choices);

      let dragging = null, offsetX = 0, offsetY = 0;
      function redraw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let i = 0; i < p.sequence.length; i++) {
          ctx.beginPath();
          ctx.lineWidth = 2;
          ctx.strokeStyle = "#bbb";
          ctx.rect(startX + i * 90, 60, 60, 60);
          ctx.stroke();
          ctx.font = "48px Arial";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          if (p.sequence[i] !== "?") {
            ctx.fillText(p.sequence[i], startX + i * 90 + 30, 90);
          } else {
            ctx.fillStyle = "#e67e22";
            ctx.fillText("?", startX + i * 90 + 30, 90);
          }
        }
        drawChoices(ctx, choices);
      }
      function getChoiceAt(x, y) {
        for (let i = choices.length - 1; i >= 0; i--) {
          const c = choices[i];
          if (Math.hypot(c.x - x, c.y - y) < 32) return i;
        }
        return null;
      }
      function isInSlot(x, y) {
        return (
          x > startX + 4 * 90 &&
          x < startX + 4 * 90 + 60 &&
          y > 60 &&
          y < 120
        );
      }
      canvas.onmousedown = function(e) {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const idx = getChoiceAt(x, y);
        if (idx !== null) {
          dragging = idx;
          offsetX = x - choices[idx].x;
          offsetY = y - choices[idx].y;
        }
      };
      canvas.onmousemove = function(e) {
        if (dragging !== null) {
          const rect = canvas.getBoundingClientRect();
          choices[dragging].x = e.clientX - rect.left - offsetX;
          choices[dragging].y = e.clientY - rect.top - offsetY;
          redraw();
        }
      };
      canvas.onmouseup = function(e) {
        if (dragging !== null) {
          const rect = canvas.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          if (isInSlot(x, y)) {
            if (choices[dragging].emoji === p.answer) {
              p.sequence[4] = p.answer;
              redraw();
              document.getElementById('feedback').textContent = "Correct!";
              setTimeout(onSuccess, 900);
            } else {
              document.getElementById('feedback').textContent = "Wrong answer, try again!";
              setTimeout(() => document.getElementById('feedback').textContent = "", 1200);
              choices[dragging].x = 200 + dragging * 120;
              choices[dragging].y = 170;
              redraw();
            }
          } else {
            choices[dragging].x = 200 + dragging * 120;
            choices[dragging].y = 170;
            redraw();
          }
          dragging = null;
        }
      };
      canvas.ontouchstart = function(e) {
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        const idx = getChoiceAt(x, y);
        if (idx !== null) {
          dragging = idx;
          offsetX = x - choices[idx].x;
          offsetY = y - choices[idx].y;
        }
      };
      canvas.ontouchmove = function(e) {
        if (dragging !== null) {
          e.preventDefault();
          const rect = canvas.getBoundingClientRect();
          const touch = e.touches[0];
          choices[dragging].x = touch.clientX - rect.left - offsetX;
          choices[dragging].y = touch.clientY - rect.top - offsetY;
          redraw();
        }
      };
      canvas.ontouchend = function(e) {
        if (dragging !== null) {
          const rect = canvas.getBoundingClientRect();
          const touch = e.changedTouches[0];
          const x = touch.clientX - rect.left;
          const y = touch.clientY - rect.top;
          if (isInSlot(x, y)) {
            if (choices[dragging].emoji === p.answer) {
              p.sequence[4] = p.answer;
              redraw();
              document.getElementById('feedback').textContent = "Correct!";
              setTimeout(onSuccess, 900);
            } else {
              document.getElementById('feedback').textContent = "Wrong answer, try again!";
              setTimeout(() => document.getElementById('feedback').textContent = "", 1200);
              choices[dragging].x = 200 + dragging * 120;
              choices[dragging].y = 170;
              redraw();
            }
          } else {
            choices[dragging].x = 200 + dragging * 120;
            choices[dragging].y = 170;
            redraw();
          }
          dragging = null;
        }
      };
      redraw();
    }
    function drawChoices(ctx, choices) {
      choices.forEach((c, idx) => {
        ctx.beginPath();
        ctx.fillStyle = "#f39c12";
        ctx.arc(c.x, c.y, 32, 0, 2 * Math.PI);
        ctx.fill();
        ctx.strokeStyle = "#d35400";
        ctx.lineWidth = 3;
        ctx.stroke();
        ctx.font = "40px Arial";
        ctx.fillStyle = "#fff";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(c.emoji, c.x, c.y + 2);
      });
    }

    function drawIntrusPuzzle(p, onSuccess) {
      const canvas = document.getElementById('puzzle-canvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      p.animals.forEach((a, idx) => {
        ctx.beginPath();
        ctx.arc(a.x, a.y, 48, 0, 2 * Math.PI);
        ctx.fillStyle = "#f39c12";
        ctx.fill();
        ctx.strokeStyle = "#d35400";
        ctx.lineWidth = 3;
        ctx.stroke();
        ctx.font = "48px Arial";
        ctx.fillStyle = "#fff";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(a.emoji, a.x, a.y + 4);
      });

      canvas.onmousedown = function(e) {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        for (let i = p.animals.length - 1; i >= 0; i--) {
          const a = p.animals[i];
          if (Math.hypot(a.x - x, a.y - y) < 48) {
            if (i === p.intrusIdx) {
              document.getElementById('feedback').textContent = "Correct!";
              setTimeout(onSuccess, 900);
            } else {
              document.getElementById('feedback').textContent = "That's not the odd one out, try again!";
              setTimeout(() => document.getElementById('feedback').textContent = "", 1200);
            }
          }
        }
      };
      canvas.ontouchstart = function(e) {
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        for (let i = p.animals.length - 1; i >= 0; i--) {
          const a = p.animals[i];
          if (Math.hypot(a.x - x, a.y - y) < 48) {
            if (i === p.intrusIdx) {
              document.getElementById('feedback').textContent = "Correct!";
              setTimeout(onSuccess, 900);
            } else {
              document.getElementById('feedback').textContent = "That's not the odd one out, try again!";
              setTimeout(() => document.getElementById('feedback').textContent = "", 1200);
            }
          }
        }
      };
    }

    document.getElementById('start-btn').onclick = function() {
      document.getElementById('start-btn').style.display = 'none';
      document.getElementById('puzzle').style.display = '';
      showStep();
    };
  </script>
</body>
</html>